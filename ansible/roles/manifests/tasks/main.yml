 tasks:
    - name: Create local K3s directory structure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      loop:
        - k3s
        - k3s/database
        - k3s/redis
        - k3s/frontend
        - k3s/backend
        - k3s/reverse-proxy
        - k3s/monitoring

    - name: Place Docker Hub secret manifest
      ansible.builtin.template:
        src: templates/docker-secret.yaml.j2
        dest: k3s/reverse-proxy/docker-secret.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place frontend deployment manifest
      ansible.builtin.template:
        src: templates/frontend-deployment.yaml.j2
        dest: k3s/frontend/frontend-deployment.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place frontend service manifest
      ansible.builtin.template:
        src: templates/frontend-service.yaml.j2
        dest: k3s/frontend/frontend-service.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place backend deployment manifest
      ansible.builtin.template:
        src: templates/backend-deployment.yaml.j2
        dest: k3s/backend/backend-deployment.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place backend service manifest
      ansible.builtin.template:
        src: templates/backend-service.yaml.j2
        dest: k3s/backend/backend-service.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place postgres deployment manifest
      ansible.builtin.template:
        src: templates/postgres-deployment.yaml.j2
        dest: k3s/database/postgres-deployment.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place postgres service manifest
      ansible.builtin.template:
        src: templates/postgres-service.yaml.j2
        dest: k3s/database/postgres-service.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place postgres configmap manifest
      ansible.builtin.template:
        src: templates/postgres-configmap.yaml.j2
        dest: k3s/database/postgres-configmap.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place postgres pvc manifest
      ansible.builtin.template:
        src: templates/postgres-pvc.yaml.j2
        dest: k3s/database/postgres-pvc.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place redis deployment manifest
      ansible.builtin.template:
        src: templates/redis-deployment.yaml.j2
        dest: k3s/redis/redis-deployment.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place redis service manifest
      ansible.builtin.template:
        src: templates/redis-service.yaml.j2
        dest: k3s/redis/redis-service.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Place ingress manifest with middleware
      ansible.builtin.template:
        src: templates/ingress.yaml.j2
        dest: k3s/reverse-proxy/ingress.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Create manifests directory on control-plane
      ansible.builtin.file:
        path: "{{ manifests_dir }}"
        state: directory
        mode: '0755'

    - name: Copy manifests to control-plane
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ manifests_dir }}/{{ item.dest }}"
        mode: '0644'
      loop:
        - { src: k3s/reverse-proxy/docker-secret.yaml, dest: reverse-proxy/docker-secret.yaml }
        - { src: k3s/database/postgres-pvc.yaml, dest: database/postgres-pvc.yaml }
        - { src: k3s/database/postgres-configmap.yaml, dest: database/postgres-configmap.yaml }
        - { src: k3s/database/postgres-deployment.yaml, dest: database/postgres-deployment.yaml }
        - { src: k3s/database/postgres-service.yaml, dest: database/postgres-service.yaml }
        - { src: k3s/redis/redis-deployment.yaml, dest: redis/redis-deployment.yaml }
        - { src: k3s/redis/redis-service.yaml, dest: redis/redis-service.yaml }
        - { src: k3s/backend/backend-deployment.yaml, dest: backend/backend-deployment.yaml }
        - { src: k3s/backend/backend-service.yaml, dest: backend/backend-service.yaml }
        - { src: k3s/frontend/frontend-deployment.yaml, dest: frontend/frontend-deployment.yaml }
        - { src: k3s/frontend/frontend-service.yaml, dest: frontend/frontend-service.yaml }
        - { src: k3s/reverse-proxy/ingress.yaml, dest: reverse-proxy/ingress.yaml }